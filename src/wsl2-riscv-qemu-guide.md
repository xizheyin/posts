# 在WSL2中运行RISC-V QEMU并执行程序指南

## 目录
1. [环境准备](#环境准备)
2. [安装QEMU](#安装qemu)
3. [下载RISC-V系统镜像](#下载risc-v系统镜像)
4. [运行RISC-V虚拟机](#运行risc-v虚拟机)
5. [在虚拟机中编译和运行程序](#在虚拟机中编译和运行程序)
6. [常见问题解决](#常见问题解决)

最近马老师让我去测试一下前段时间我release的riscv的buck2是否有用，
遇到了配置环境的问题，容易忘记，下面记录一下。

## 环境准备

### 检查WSL2环境
首先确认您的WSL2环境是否正常：

```bash
# 检查WSL版本
wsl --version

# 检查当前运行的发行版
wsl --list --verbose

# 更新包管理器
sudo apt update && sudo apt upgrade -y
```

### 安装必要的依赖
```bash
# 安装编译工具和依赖
sudo apt install -y build-essential git wget curl

# 安装QEMU相关依赖
sudo apt install -y libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev
sudo apt install -y libnfs-dev libiscsi-dev libssh-dev libvde-dev
sudo apt install -y libvdeplug-dev libvte-dev libxen-dev libxenstore3.0
```

## 安装QEMU

### 方法1：通过包管理器安装（推荐）
```bash
# 安装QEMU
sudo apt install -y qemu-system-misc qemu-utils

# 验证安装
qemu-system-riscv64 --version
```

### 方法2：从源码编译安装
如果需要最新版本或特定功能，可以从源码编译：

```bash
# 下载QEMU源码
cd ~
wget https://download.qemu.org/qemu-8.2.0.tar.xz
tar xf qemu-8.2.0.tar.xz
cd qemu-8.2.0

# 配置和编译
./configure --target-list=riscv64-softmmu,riscv64-linux-user
make -j$(nproc)
sudo make install

# 验证安装
qemu-system-riscv64 --version
```

## 下载RISC-V系统镜像

### 方案一：使用Ubuntu RISC-V镜像（推荐新手）

#### 下载Ubuntu RISC-V镜像
```bash
# 创建目录
mkdir -p ~/riscv-vm
cd ~/riscv-vm

# 下载Ubuntu RISC-V镜像（约2GB）
wget https://cdimage.ubuntu.com/releases/22.04/release/ubuntu-22.04.3-preinstalled-server-riscv64.img.xz

# 解压镜像
unxz ubuntu-22.04.3-preinstalled-server-riscv64.img.xz

# 验证镜像
ls -lh ubuntu-22.04.3-preinstalled-server-riscv64.img
```

#### 创建Ubuntu启动脚本
```bash
cat > start-ubuntu-riscv.sh << 'EOF'
#!/bin/bash

# Ubuntu RISC-V虚拟机启动脚本
VM_IMAGE="ubuntu-22.04.3-preinstalled-server-riscv64.img"
VM_MEMORY="2G"
VM_CORES="2"

# 检查镜像文件是否存在
if [ ! -f "$VM_IMAGE" ]; then
    echo "错误：找不到镜像文件 $VM_IMAGE"
    echo "请确保镜像文件在当前目录中"
    exit 1
fi

echo "启动Ubuntu RISC-V虚拟机..."
echo "镜像文件: $VM_IMAGE"
echo "内存: $VM_MEMORY"
echo "CPU核心: $VM_CORES"
echo ""

# 启动虚拟机
qemu-system-riscv64 \
    -machine virt \
    -cpu rv64 \
    -m $VM_MEMORY \
    -smp $VM_CORES \
    -device virtio-blk-device,drive=hd0 \
    -drive file=$VM_IMAGE,if=none,id=hd0 \
    -device virtio-net-device,netdev=net0 \
    -netdev user,id=net0,hostfwd=tcp::2222-:22 \
    -device virtio-rng-device \
    -device virtio-balloon-device \
    -nographic \
    -serial mon:stdio \
    -bios /usr/share/qemu-efi-aarch64/QEMU_EFI.fd \
    -append "root=/dev/vda1 rw console=ttyS0"
EOF

# 给脚本添加执行权限
chmod +x start-ubuntu-riscv.sh
```

### 方案二：使用Debian RISC-V镜像（适合高级用户）

#### 下载Debian RISC-V镜像

下载镜像的官方网站是 <https://people.debian.org/~gio/dqib/>

```bash
# 创建目录
mkdir -p ~/riscv-vm-debian
cd ~/riscv-vm-debian

# 下载Debian RISC-V镜像（约350MB）
wget -O debian-riscv64-virt.zip https://gitlab.com/api/v4/projects/giomasce%2Fdqib/jobs/artifacts/master/download?job=convert_riscv64-virt

# 解压镜像（实际是ZIP格式）
unzip debian-riscv64-virt.zip

# 查看解压后的文件
ls -la dqib_riscv64-virt/
```

解压后会得到以下文件：
- `image.qcow2` - 虚拟机磁盘镜像
- `kernel` - Linux内核
- `initrd` - 初始RAM磁盘
- `ssh_user_rsa_key` - SSH私钥
- `ssh_user_ed25519_key` - SSH私钥
- `ssh_user_ecdsa_key` - SSH私钥
- `readme.txt` - 说明文档

#### 安装必要的包
在启动虚拟机之前，需要安装OpenSBI和U-Boot**（注意看解压后的readme.txt）**：

```bash
# 安装OpenSBI和U-Boot
sudo apt update
sudo apt install -y opensbi u-boot-qemu
```
这里是readme.txt，里面写了让我们安装这两个包：
```
This is a Debian image generated by the Debian Quick Image Baker.
It was created on Sun Jun  2 06:55:13 UTC 2024
See https://gitlab.com/giomasce/dqib for more information.
You need to install packages opensbi and u-boot-qemu
(Try to) boot with:
qemu-system-riscv64 -machine 'virt' -cpu 'rv64' -m 1G -device virtio-blk-device,drive=hd -drive file=image.qcow2,if=none,id=hd -device virtio-net-device,netdev=net -netdev user,id=net,hostfwd=tcp::2222-:22 -bios /usr/lib/riscv64-linux-gnu/opensbi/generic/fw_jump.elf -kernel /usr/lib/u-boot/qemu-riscv64_smode/uboot.elf -object rng-random,filename=/dev/urandom,id=rng -device virtio-rng-device,rng=rng -nographic -append "root=LABEL=rootfs console=ttyS0"
You can use Ctrl-a x to exit from QEMU.
You can login with root:root or debian:debian, or using the identities ssh_user_*_key in this directory.
You can also login with SSH on the local port 2222 (this will give you a much better terminal emulation than the QEMU default).
Some machines support a video interface, which you can enable removing the -nographic option and possibly also the console= kernel argument.
```

**重要说明**：Debian RISC-V镜像使用特殊的启动方式，需要OpenSBI作为固件和U-Boot作为引导加载程序。这与Ubuntu镜像不同，Ubuntu使用预编译的内核和initrd直接启动。

#### 创建Debian启动脚本
```bash
cat > start-debian-riscv.sh << 'EOF'
#!/bin/bash

# Debian RISC-V虚拟机启动脚本
VM_IMAGE="dqib_riscv64-virt/image.qcow2"
VM_MEMORY="2G"
VM_CORES="2"

# 检查文件是否存在
if [ ! -f "$VM_IMAGE" ]; then
    echo "错误：找不到镜像文件 $VM_IMAGE"
    echo "请先下载并解压Debian RISC-V镜像"
    exit 1
fi

echo "启动Debian RISC-V虚拟机..."
echo "镜像文件: $VM_IMAGE"
echo "内存: $VM_MEMORY"
echo "CPU核心: $VM_CORES"
echo ""

# 启动虚拟机（按照readme中的正确方式）
qemu-system-riscv64 \
    -machine 'virt' \
    -cpu 'rv64' \
    -m $VM_MEMORY \
    -smp $VM_CORES \
    -device virtio-blk-device,drive=hd \
    -drive file=$VM_IMAGE,if=none,id=hd \
    -device virtio-net-device,netdev=net \
    -netdev user,id=net,hostfwd=tcp::2222-:22 \
    -bios /usr/lib/riscv64-linux-gnu/opensbi/generic/fw_jump.elf \
    -kernel /usr/lib/u-boot/qemu-riscv64_smode/uboot.elf \
    -object rng-random,filename=/dev/urandom,id=rng \
    -device virtio-rng-device,rng=rng \
    -nographic \
    -append "root=LABEL=rootfs console=ttyS0"
EOF

chmod +x start-debian-riscv.sh
```

## 运行RISC-V虚拟机

### 方案一：Ubuntu RISC-V（快速开始）

#### 启动Ubuntu虚拟机
```bash
# 进入虚拟机目录
cd ~/riscv-vm

# 启动虚拟机
./start-ubuntu-riscv.sh
```

#### Ubuntu首次启动配置
首次启动时，您需要：

1. **等待系统启动**：系统会自动启动到登录界面
2. **默认登录信息**：
   - 用户名：`ubuntu`
   - 密码：`ubuntu`
3. **首次登录后修改密码**：
   ```bash
   passwd
   ```

### 方案二：Debian RISC-V（预装系统）

#### 启动Debian虚拟机
```bash
# 进入虚拟机目录
cd ~/riscv-vm-debian

# 启动虚拟机
./start-debian-riscv.sh
```

#### Debian首次启动配置
首次启动时，您需要：

1. **等待系统启动**：系统会自动启动到登录界面
2. **控制台登录**：在QEMU控制台中直接登录
   - 用户名：`debian` 或 `root`
   - 密码：`debian` 或 `root`
3. **SSH连接**：也可以使用提供的SSH密钥连接到虚拟机
   ```bash
   # 设置SSH密钥权限
   chmod 600 dqib_riscv64-virt/ssh_user_rsa_key
   
   # 连接到虚拟机
   ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost
   ```

#### 解决sudo命令缺失问题
如果遇到`sudo: command not found`错误，请按以下步骤解决：

```bash
# 1. 切换到root用户
su - root
# 密码: root

# 2. 安装sudo包
apt update
apt install -y sudo

# 3. 将debian用户添加到sudo组
usermod -aG sudo debian

# 4. 配置sudo权限（可选）
echo "debian ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# 5. 退出root用户
exit

# 6. 重新登录debian用户
exit
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost

# 7. 测试sudo命令
sudo apt update
```

**或者直接使用root用户**：
```bash
# 如果不想配置sudo，可以直接使用root用户
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 root@localhost
# 密码: root
```

### 网络配置
虚拟机启动后，网络应该自动配置。您可以通过SSH连接到虚拟机：

```bash
# Ubuntu虚拟机连接
ssh -p 2222 ubuntu@localhost

# Debian虚拟机连接（使用SSH密钥）
chmod 600 dqib_riscv64-virt/ssh_user_rsa_key
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost
```

### 在Windows主机用VSCode连接WSL2中的Debian RISC-V虚拟机

#### 重要限制说明
**VSCode不支持RISC-V架构的远程开发**。VSCode的Remote-SSH插件需要目标系统支持x86_64或ARM64架构，而RISC-V架构目前不被支持。

#### 替代方案：使用rsync同步开发
在WSL2中设置自动文件同步：

```bash
# 创建同步脚本
cat > sync-to-vm.sh << 'EOF'
#!/bin/bash
# 同步本地文件到虚拟机
rsync -avz --delete \
    -e "ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222" \
    ./src/ debian@localhost:~/project/
EOF

chmod +x sync-to-vm.sh

# 使用inotify-tools监控文件变化
sudo apt install -y inotify-tools

# 创建自动同步脚本
cat > auto-sync.sh << 'EOF'
#!/bin/bash
while inotifywait -r -e modify,create,delete ./src/; do
    ./sync-to-vm.sh
    echo "文件已同步到虚拟机 $(date)"
done
EOF

chmod +x auto-sync.sh
```

运行`./auto-sync.sh`就可以实时讲wsl的`./src`文件夹的内容同步到debian虚拟机的`~/project/`文件夹。
只需要在wsl的src文件夹开发就可以了

#### 性能监控
```bash
# 在虚拟机中监控系统资源
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost "htop"

# 监控程序性能
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost "time ./my_program"
```

#### 注意事项
- RISC-V架构的限制是暂时的，随着RISC-V生态的发展，未来可能会有更好的IDE支持
- 建议使用WSL2作为主要开发环境，虚拟机主要用于测试和验证
- 定期备份重要的代码和配置文件
- 考虑使用CI/CD流水线自动化编译和测试过程

## 在虚拟机中编译和运行程序

### 安装开发工具

#### Ubuntu RISC-V
```bash
# 更新包管理器
sudo apt update

# 安装编译工具
sudo apt install -y build-essential gcc g++ make cmake

# 安装调试工具
sudo apt install -y gdb valgrind

# 安装常用库
sudo apt install -y libc6-dev libstdc++6-dev
```

#### Debian RISC-V
```bash
# 更新包管理器
sudo apt update

# 安装编译工具
sudo apt install -y build-essential gcc g++ make cmake

# 安装调试工具
sudo apt install -y gdb valgrind

# 安装常用库
sudo apt install -y libc6-dev libstdc++6-dev

# 安装其他有用的工具
sudo apt install -y vim nano git curl wget
```

**注意**：如果遇到`sudo: command not found`错误，请先参考上面的"解决sudo命令缺失问题"部分，或者直接使用root用户：

```bash
# 使用root用户安装软件包
su - root
# 密码: root

apt update
apt install -y build-essential gcc g++ make cmake gdb valgrind libc6-dev libstdc++6-dev vim nano git curl wget
```

#### 处理Debian系统提示
在安装软件包时，可能会遇到以下提示：

**1. 服务重启提示**
```
Restart services during package upgrades without asking?
```
- 选择 **Yes**（推荐）：自动重启服务，避免每次升级时被询问
- 选择 **No**：每次升级时手动选择要重启的服务

**2. 配置文件冲突提示**
```
Configuration file '/etc/xxx/xxx.conf'
==> Modified (by you or by a script) since installation.
==> Package distributor has shipped an updated version.
   What would you like to do about it?
```
- 选择 **install the package maintainer's version**：使用包维护者的版本
- 选择 **keep the local version currently installed**：保持当前本地版本
- 选择 **show the differences between the versions**：显示版本差异

**3. 非交互式安装（推荐）**
```bash
# 使用DEBIAN_FRONTEND=noninteractive避免交互提示
DEBIAN_FRONTEND=noninteractive apt install -y build-essential gcc g++ make cmake

# 或者使用-y参数自动回答yes
apt install -y build-essential gcc g++ make cmake
```

**4. SSH服务重启失败（正常现象）**
如果在SSH连接中遇到以下提示：
```
Failure restarting some services for GNU libc upgrade
The following services could not be restarted for the GNU libc library upgrade:
ssh
You will need to start these manually by running 'invoke-rc.d <service> start'.
```

**这是正常现象**，因为：
- 您正在通过SSH连接到虚拟机
- 重启SSH服务会断开当前连接
- 系统无法在SSH会话中重启SSH服务

**解决方案**：
```bash
# 方法1：手动重启SSH服务（会断开连接）
invoke-rc.d ssh restart

# 方法2：检查SSH服务状态
systemctl status ssh

# 方法3：如果SSH服务停止，重新启动虚拟机
# 在WSL2中重新运行启动脚本
./start-debian-riscv.sh

# 方法4：忽略SSH服务重启（推荐）
# 继续使用当前SSH连接，新库会在下次重启时生效
```

**注意**：SSH服务重启失败不会影响其他软件的安装和使用。

### 编译和运行C程序
创建一个简单的C程序进行测试：

```bash
# 创建测试目录
mkdir ~/test-programs
cd ~/test-programs

# 创建Hello World程序
cat > hello.c << 'EOF'
#include <stdio.h>

int main() {
    printf("Hello from RISC-V!\n");
    printf("Architecture: RISC-V 64-bit\n");
    return 0;
}
EOF

# 编译程序
gcc -o hello hello.c

# 运行程序
./hello
```

得到结果：
```
debian@debian:~/test-programs$ ./hello 
Hello from RISC-V!
Architecture: RISC-V 64-bit
```

### 编译和运行C++程序
```bash
# 创建C++程序
cat > hello.cpp << 'EOF'
#include <iostream>

int main() {
    std::cout << "Hello from RISC-V C++!" << std::endl;
    std::cout << "C++ version: " << __cplusplus << std::endl;
    return 0;
}
EOF

# 编译C++程序
g++ -o hello_cpp hello.cpp

# 运行程序
./hello_cpp
```

### 编译和运行Python程序（Debian）
```bash
# 安装Python
sudo apt install -y python3 python3-pip

# 创建Python程序
cat > hello.py << 'EOF'
#!/usr/bin/env python3
import platform
import os

print("Hello from RISC-V Python!")
print(f"Python version: {platform.python_version()}")
print(f"Architecture: {platform.machine()}")
print(f"Distribution: {platform.linux_distribution()}")
print(f"Kernel: {platform.release()}")
EOF

# 运行Python程序
python3 hello.py
```

### 交叉编译测试
在WSL2主机上交叉编译RISC-V程序：

```bash
# 安装RISC-V交叉编译工具链
sudo apt install -y gcc-riscv64-linux-gnu g++-riscv64-linux-gnu

# 创建测试程序
cat > cross_compile_test.c << 'EOF'
#include <stdio.h>

int main() {
    printf("Cross-compiled for RISC-V!\n");
    return 0;
}
EOF

# 交叉编译
riscv64-linux-gnu-gcc -o cross_test cross_compile_test.c

# 将编译好的程序传输到虚拟机
# Ubuntu
scp -P 2222 cross_test ubuntu@localhost:~/
# Debian（使用SSH密钥）
scp -i dqib_riscv64-virt/ssh_user_rsa_key -P 2222 cross_test debian@localhost:~/

# 在虚拟机中运行
# Ubuntu
ssh -p 2222 ubuntu@localhost "chmod +x ~/cross_test && ~/cross_test"
# Debian
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost "chmod +x ~/cross_test && ~/cross_test"
```

#### ⚠️ 交叉编译限制说明
**RISC-V交叉编译工具链功能有限**：
- 某些高级C++特性可能不支持
- 标准库功能可能不完整
- 调试信息可能不准确
- 某些第三方库可能无法交叉编译

#### 推荐的开发策略

##### 1. 本地编译优先
```bash
# 在虚拟机内直接编译（推荐）
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost "cd ~/project && gcc -o my_program my_program.c"
```

##### 2. 使用Docker容器
```bash
# 创建RISC-V开发容器
cat > Dockerfile.riscv << 'EOF'
FROM ubuntu:22.04
RUN apt update && apt install -y \
    gcc-riscv64-linux-gnu \
    g++-riscv64-linux-gnu \
    make \
    cmake \
    git
WORKDIR /workspace
EOF

# 构建容器
docker build -f Dockerfile.riscv -t riscv-dev .

# 在容器中编译
docker run -v $(pwd):/workspace riscv-dev make
```

##### 3. 使用QEMU用户模式模拟
```bash
# 安装QEMU用户模式
sudo apt install -y qemu-user-static

# 直接运行RISC-V程序（在x86_64系统上）
qemu-riscv64-static ./cross_test
```

##### 4. 分阶段开发
```bash
# 阶段1：在WSL2中开发和单元测试
gcc -o test_program test_program.c
./test_program

# 阶段2：交叉编译到RISC-V
riscv64-linux-gnu-gcc -o test_program_riscv test_program.c

# 阶段3：在虚拟机中验证
scp -i dqib_riscv64-virt/ssh_user_rsa_key -P 2222 test_program_riscv debian@localhost:~/
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost "./test_program_riscv"
```

## 性能优化和配置

### 优化虚拟机性能
修改启动脚本以提升性能：

#### Ubuntu优化脚本
```bash
cat > start-ubuntu-riscv-optimized.sh << 'EOF'
#!/bin/bash

VM_IMAGE="ubuntu-22.04.3-preinstalled-server-riscv64.img"
VM_MEMORY="4G"
VM_CORES="4"

qemu-system-riscv64 \
    -machine virt,accel=kvm \
    -cpu rv64 \
    -m $VM_MEMORY \
    -smp $VM_CORES \
    -device virtio-blk-device,drive=hd0 \
    -drive file=$VM_IMAGE,if=none,id=hd0,cache=writeback \
    -device virtio-net-device,netdev=net0 \
    -netdev user,id=net0,hostfwd=tcp::2222-:22 \
    -device virtio-rng-device \
    -device virtio-balloon-device \
    -nographic \
    -serial mon:stdio \
    -bios /usr/share/qemu-efi-aarch64/QEMU_EFI.fd \
    -append "root=/dev/vda1 rw console=ttyS0"
EOF

chmod +x start-ubuntu-riscv-optimized.sh
```

#### Debian优化脚本
```bash
cat > start-debian-riscv-optimized.sh << 'EOF'
#!/bin/bash

VM_IMAGE="dqib_riscv64-virt/image.qcow2"
VM_MEMORY="4G"
VM_CORES="4"

qemu-system-riscv64 \
    -machine 'virt' \
    -cpu 'rv64' \
    -m $VM_MEMORY \
    -smp $VM_CORES \
    -device virtio-blk-device,drive=hd \
    -drive file=$VM_IMAGE,if=none,id=hd,cache=writeback \
    -device virtio-net-device,netdev=net \
    -netdev user,id=net,hostfwd=tcp::2222-:22 \
    -bios /usr/lib/riscv64-linux-gnu/opensbi/generic/fw_jump.elf \
    -kernel /usr/lib/u-boot/qemu-riscv64_smode/uboot.elf \
    -object rng-random,filename=/dev/urandom,id=rng \
    -device virtio-rng-device,rng=rng \
    -nographic \
    -append "root=LABEL=rootfs console=ttyS0"
EOF

chmod +x start-debian-riscv-optimized.sh
```

### 配置持久化存储

#### Ubuntu持久化存储
```bash
# 创建新的磁盘镜像
qemu-img create -f qcow2 ubuntu-riscv-persistent.qcow2 10G

# 修改启动脚本使用持久化镜像
sed -i 's/ubuntu-22.04.3-preinstalled-server-riscv64.img/ubuntu-riscv-persistent.qcow2/g' start-ubuntu-riscv.sh
```

#### Debian快照和备份
```bash
# 创建虚拟机快照
qemu-img snapshot -c snapshot1 dqib_riscv64-virt/image.qcow2

# 列出快照
qemu-img snapshot -l dqib_riscv64-virt/image.qcow2

# 恢复到快照
qemu-img snapshot -a snapshot1 dqib_riscv64-virt/image.qcow2

# 删除快照
qemu-img snapshot -d snapshot1 dqib_riscv64-virt/image.qcow2
```

## 常见问题解决

### 1. QEMU启动失败
```bash
# 检查QEMU是否正确安装
which qemu-system-riscv64

# 检查依赖库
ldd $(which qemu-system-riscv64)

# 重新安装QEMU
sudo apt remove --purge qemu-system-misc
sudo apt install qemu-system-misc
```

### 2. 虚拟机无法启动
```bash
# Debian镜像检查
file dqib_riscv64-virt/image.qcow2

# 检查磁盘镜像信息
qemu-img info dqib_riscv64-virt/image.qcow2

# 检查必要的包是否安装
dpkg -l | grep -E "(opensbi|u-boot-qemu)"

# 重新下载镜像
# Ubuntu
wget -c https://cdimage.ubuntu.com/releases/24.04.2/release/ubuntu-24.04.2-preinstalled-server-riscv64+nezha.img.xz
# Debian
wget -O debian-riscv64-virt.zip https://gitlab.com/api/v4/projects/giomasce%2Fdqib/jobs/artifacts/master/download?job=convert_riscv64-virt
```

### 3. 网络连接问题
```bash
# 检查端口转发
netstat -tlnp | grep 2222

# 测试SSH连接
# Ubuntu
ssh -v -p 2222 ubuntu@localhost
# Debian
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -v -p 2222 debian@localhost

# 在虚拟机内检查网络
ip addr show
ping -c 3 8.8.8.8
```

### 4. 性能问题
```bash
# 检查KVM支持
ls /dev/kvm

# 检查CPU虚拟化支持
egrep -c '(vmx|svm)' /proc/cpuinfo

# 检查虚拟机内CPU信息
ssh -p 2222 ubuntu@localhost "lscpu"
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost "lscpu"
```

### 5. 磁盘空间不足（Debian）
```bash
# 扩展磁盘镜像
qemu-img resize dqib_riscv64-virt/image.qcow2 +5G

# 在虚拟机内扩展分区
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost "sudo fdisk /dev/vda"
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost "sudo resize2fs /dev/vda1"
```

### 6. sudo命令缺失（Debian）
如果遇到`sudo: command not found`错误：

```bash
# 方法1：切换到root用户
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 root@localhost
# 密码: root

# 方法2：安装sudo（需要root权限）
su - root
apt update
apt install -y sudo
usermod -aG sudo debian
exit

# 方法3：直接使用root用户进行所有操作
# 在SSH连接时使用root用户而不是debian用户
```

### 7. 权限问题
```bash
# 检查用户权限
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost "id"

# 检查sudo组
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 debian@localhost "groups"

# 如果debian用户不在sudo组中，使用root用户添加
ssh -i dqib_riscv64-virt/ssh_user_rsa_key -p 2222 root@localhost "usermod -aG sudo debian"
```

### 8. 系统时间错误导致软件源验证失败
如果遇到"Release file is not valid yet"错误，说明系统时间不正确：

```bash
# 检查当前系统时间
date


# 强制设置正确时间
date -s "2024-01-15 12:00:00"

# 方法1：同步系统时间（推荐）
apt update
apt install -y ntpdate
ntpdate -s time.nist.gov

# 方法2：手动设置时间
date -s "$(curl -s --head http://www.baidu.com | grep ^Date: | sed 's/Date: //g')"

# 方法3：使用timedatectl（如果可用）
timedatectl set-ntp true

# 方法4：临时忽略时间验证（不推荐，仅用于紧急情况）
apt update -o Acquire::Check-Valid-Until=false

# 验证时间是否正确
date
```

### 9. 软件源配置问题
如果软件源有问题，可以重新配置：

```bash
# 备份当前源列表
cp /etc/apt/sources.list /etc/apt/sources.list.backup

# 使用稳定的软件源
cat > /etc/apt/sources.list << 'EOF'
deb http://deb.debian.org/debian/ bookworm main contrib non-free
deb http://deb.debian.org/debian/ bookworm-updates main contrib non-free
deb http://security.debian.org/debian-security bookworm-security main contrib non-free
EOF

# 更新软件包列表
apt update
```


## 方案对比

| 特性 | Ubuntu RISC-V | Debian RISC-V |
|------|---------------|---------------|
| **安装难度** | 简单（预装系统） | 简单（预装系统） |
| **启动速度** | 快 | 快 |
| **系统大小** | 较大（约2GB） | 中等（约1.5GB） |
| **软件包** | 丰富 | 稳定 |
| **适合用户** | 新手、快速测试 | 高级用户、学习 |
| **维护** | 简单 | 简单 |
| **镜像来源** | Ubuntu官方 | Debian社区维护 |

## 总结

通过本指南，我们在WSL2环境中：

1. 安装QEMU模拟器
2. 了解Ubuntu和Debian两种RISC-V镜像方案
3. 配置并启动RISC-V虚拟机
4. 在虚拟机中编译和运行程序
5. 了解性能优化和故障排除方法